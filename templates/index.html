<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Todo App</title>

    <!-- Bootstrap 5 CSS (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- İkonlar (Bootstrap Icons CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      /* Toast konumlandırma */
      .toast-container {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 1100;
      }
    </style>
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-white bg-white shadow-sm position-relative">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">
      <i class="bi bi-check2-square"></i> MyTodo
    </a>

    <span class="text-muted small position-absolute top-50 start-50 translate-middle">
      Detaylı Görev Yönetimi | Hoşgeldin <i>Hafize Şenyıl</i>
    </span>

    <a href="{{ url_for('new_task') }}" class="btn btn-primary btn-sm">
      <i class="bi bi-plus-lg"></i> Yeni Görev Ekle
    </a>
  </div>
</nav>



    <main class="container-fluid py-3">
      <!-- TOAST MESAJLARI -->
      <div class="toast-container">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, msg in messages %}
        <div
          class="toast align-items-center text-bg-{{ 'success' if category=='success' else ('warning' if category=='warning' else 'danger') }} border-0"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="d-flex">
            <div class="toast-body">{{ msg }}</div>
            <button
              type="button"
              class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast"
              aria-label="Kapat"
            ></button>
          </div>
        </div>
        {% endfor %} {% endif %} {% endwith %}
      </div>

      <!-- BURADAN İTİBAREN SAYFA İÇERİĞİ -->
      <div class="row g-3">
        
        <!-- SOL PANEL: Açılan görevler listesi -->
        <div class="col-lg-6 left-panel">
          <div class="card shadow-sm mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">

              <strong>
                <i class="bi bi-list-task me-2"></i> Açılan Görevler
              </strong>

              <!-- Filtre Temizle Butonu -->
              <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-x-circle me-1"></i> Filtreyi Temizle
              </a>

            </div>
            <div class="card-body p-2">
              <!-- FİLTRE BUTONLARI -->
              <div class="d-flex flex-wrap gap-1 mb-3">
                <a href="{{ url_for('index', time_filter='late') }}"
                  class="btn btn-sm btn-danger flex-fill {% if selected_filters and selected_filters.time_filter == 'late' %}active{% endif %}">
                    <i class="bi bi-circle-fill me-1"></i> Gecikmiş
                </a>
                <a href="{{ url_for('index', time_filter='not_started_yet') }}"
                  class="btn btn-sm btn-secondary flex-fill {% if selected_filters and selected_filters.time_filter == 'not_started_yet' %}active{% endif %}">
                    <i class="bi bi-circle me-1"></i> Zamanı Gelmemiş
                </a>
                <a href="{{ url_for('index', time_filter='on_time') }}"
                  class="btn btn-sm btn-success flex-fill {% if selected_filters and selected_filters.time_filter == 'on_time' %}active{% endif %}">
                    <i class="bi bi-check-circle-fill me-1"></i> Zamanında Bitmiş
                </a>
                <a href="{{ url_for('index', time_filter='early') }}"
                  class="btn btn-sm btn-primary flex-fill {% if selected_filters and selected_filters.time_filter == 'early' %}active{% endif %}">
                    <i class="bi bi-hourglass-split me-1"></i> Erken Bitmiş
                </a>
              </div>



              <div class="d-flex flex-wrap gap-1 mb-3">
    <button class="btn btn-sm btn-warning flex-fill {% if selected_filters.status_filter == 'pending' %}active{% endif %}" 
            onclick="window.location.href='/?status_filter=pending'">
        <i class="bi bi-square-fill me-1"></i> Bekleyen
    </button>
    <button class="btn btn-sm btn-primary flex-fill {% if selected_filters.status_filter == 'in_progress' %}active{% endif %}" 
            onclick="window.location.href='/?status_filter=in_progress'">
        <i class="bi bi-hourglass-split me-1"></i> İşlemde
    </button>
    <button class="btn btn-sm btn-success flex-fill {% if selected_filters.status_filter == 'completed' %}active{% endif %}" 
            onclick="window.location.href='/?status_filter=completed'">
        <i class="bi bi-check-square-fill me-1"></i> Tamamlanmış
    </button>
</div>



              <div class="d-flex flex-wrap gap-1 mb-3">
                  <button class="btn btn-sm btn-danger flex-fill">
                      <i class="bi bi-exclamation-circle-fill me-1"></i> Acil
                  </button>
                  <button class="btn btn-sm btn-primary flex-fill">
                      <i class="bi bi-exclamation-circle me-1"></i> Orta
                  </button>
                  <button class="btn btn-sm btn-secondary flex-fill">
                      <i class="bi bi-circle me-1"></i> Önemsiz
                  </button>
              </div>


              <!-- GÖREV LİSTESİ TABLOSU -->
              <div
                class="table-responsive"
                style="max-height: calc(100vh - 300px); overflow-y: auto"
              >
                {% if tasks %}
                <table class="table table-sm table-hover small mb-0">
                  <thead>
                    <tr>
                      <th>Görev Adı</th>
                      <th class="text-nowrap">Açılma Tarihi</th>
                      <th class="text-end">Aksiyonlar</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for task in tasks %}
                    <tr>
                      <td class="align-middle fw-bold">{{ task.title }}</td>
                      <td class="align-middle text-nowrap">
                        {{ task.created_at.strftime('%Y-%m-%d') }}
                      </td>
                      <td class="text-end text-nowrap align-middle">
                        {% if task.status == 'pending' %}
                          <a href="{{ url_for('start_task', id=task.id) }}" class="btn btn-sm btn-primary p-1"
                            {% if active_task %} disabled {% endif %}>
                            <i class="bi bi-play-fill"></i> Başlat
                          </a>
                        {% endif %}

                        <a href="{{ url_for('edit', id=task.id) }}"
                          class="btn btn-sm btn-warning p-1"
                          title="Düzenle">
                          <i class="bi bi-pencil-square"></i>
                        </a>
                        <form
                          action="{{ url_for('delete_task', id=task.id) }}"
                          method="POST"
                          class="d-inline">
                          <button
                            type="submit"
                            class="btn btn-sm btn-danger p-1"
                            title="Sil"
                            onclick="return confirm('Görevi silmek istediğine emin misin?');">
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                <p class="text-muted small mb-0 p-2 text-center">
                  Henüz açık görev yok.
                </p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

       
        <!-- ORTA PANEL: Durum ve Öncelik Kartları + Detay Kartı -->
<div class="col-lg-6">
    <div class="row g-3">
        <!-- Üstte iki kart yan yana -->
        <div class="col-6">
            <!-- Görev Durumu Kartı -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <strong><i class="bi bi-list-check me-2"></i> Görev Durumu</strong>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Bekleyen</span>
                        <span class="badge bg-warning text-dark">
                            {{ tasks|selectattr('status','equalto','pending')|list|length }}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>İşlemde</span>
                        <span class="badge bg-primary">
                            {{ tasks|selectattr('status','equalto','in_progress')|list|length }}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Tamamlanmış</span>
                        <span class="badge bg-success">
                            {{ tasks|selectattr('status','equalto','completed')|list|length }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6">
            <!-- Öncelik Kartı -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <strong><i class="bi bi-exclamation-circle me-2"></i> Öncelik</strong>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Acil</span>
                        <span class="badge bg-danger">
                            {{ tasks|selectattr('priority','equalto','high')|list|length }}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Orta</span>
                        <span class="badge bg-primary">
                            {{ tasks|selectattr('priority','equalto','medium')|list|length }}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Önemsiz</span>
                        <span class="badge bg-secondary">
                            {{ tasks|selectattr('priority','equalto','low')|list|length }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

    
        <!-- Altında tek kart: Seçili Görev Detay Kartı -->
<div class="col-12">
    {% if active_task %}
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <strong><i class="bi bi-info-circle me-2"></i> İşlemdeki Görevin Detayı</strong>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <!-- Başlık -->
                <div class="col-md-3 fw-bold">Başlık:</div>
                <div class="col-md-3">{{ active_task.title }}</div>

                <!-- Açıklama -->
                <div class="col-md-3 fw-bold">Açıklama:</div>
                <div class="col-md-3">{{ active_task.description or "Yok" }}</div>

                <!-- Başlama Tarihi -->
                <div class="col-md-3 fw-bold">Başlama Tarihi:</div>
                <div class="col-md-3">
                    {{ active_task.started_at.strftime('%Y-%m-%d') if active_task.started_at else "Belirtilmemiş" }}
                </div>

                <!-- Tahmini Bitiş -->
                <div class="col-md-3 fw-bold">Tahmini Bitiş:</div>
                <div class="col-md-3">
                    {{ active_task.due_date.strftime('%Y-%m-%d') if active_task.due_date else "Belirtilmemiş" }}
                </div>

                <!-- Öncelik ve Zaman Durumu yan yana -->
                <div class="row g-2 align-items-center">
                    <!-- Öncelik -->
                    <div class="col-md-6 d-flex align-items-center">
                        <div class="fw-bold me-2">Öncelik:</div>
                        {% if active_task.priority == 'high' %}
                            <span class="badge bg-danger">Acil</span>
                        {% elif active_task.priority == 'medium' %}
                            <span class="badge bg-primary">Orta</span>
                        {% elif active_task.priority == 'low' %}
                            <span class="badge bg-secondary">Önemsiz</span>
                        {% endif %}
                    </div>

                <!-- Zaman Durumu -->
                <div class="col-md-6 d-flex align-items-center">
                    <div class="fw-bold me-2">Zaman Durumu:</div>
                    {% if active_task.due_date %}
                        {% if active_task.due_date.date() < today %}
                            <span class="badge bg-danger">Gecikmiş</span>
                        {% elif active_task.completed_at and active_task.due_date.date() >= active_task.completed_at.date() %}
                            <span class="badge bg-success">Zamanında Bitmiş</span>
                        {% elif not active_task.start_at %}
                            <span class="badge bg-secondary">Zamanı Gelmemiş</span>
                        {% else %}
                            <span class="badge bg-primary">Erken Bitmiş</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-dark">Tarih Yok</span>
                    {% endif %}
                </div>
</div>

</div>

            </div>

            <hr>

            <!-- Butonlar ve kalan süre -->
            <div class="d-flex justify-content-between align-items-center ">
                <div class="d-flex gap-2 mb-2 px-2">
                    {% if active_task %}
                      {% if active_task.status == 'in_progress' %}
                    <a href="{{ url_for('pause_task', id=active_task.id) }}" class="btn btn-warning">
                      <i class="bi bi-pause-fill"></i> Duraklat</a>
                    <a href="{{ url_for('finish_task', id=active_task.id) }}" class="btn btn-success">
                      <i class="bi bi-check2-square"></i> Bitir</a>
                  {% endif %}
                  {% else %}
                      <div class="text-center text-muted">Başlatılacak görev yok.</div>
                  {% endif %}

                </div>
                <!-- Kalan süre -->
                <div class="text-end fw-bold mb-2 px-3">
                    {% if active_task.due_date and active_task.started_at %}
                        {% set remaining_time = (active_task.due_date - active_task.started_at).days %}
                        Kalan: {{ remaining_time }} gün
                    {% else %}
                        Kalan süre yok
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card shadow-sm">
        <div class="card-body text-center text-muted">
            Başlatılmış görev yok.
        </div>
    </div>
    {% endif %}
</div>


<div class="col-12 mt-3">
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <strong><i class="bi bi-info-circle me-2"></i> Görev Özetleri</strong>
        </div>
        <div class="card-body">
            Buraya özetlerim gelecek.
        </div>
    </div>
</div>
      </div>
    </main>

    <!-- Bootstrap 5 JS Bundle (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Toast otomatik gösterme ve kapanma -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var toastElList = [].slice.call(document.querySelectorAll(".toast"));
        var toastList = toastElList.map(function (toastEl) {
          var t = new bootstrap.Toast(toastEl, { delay: 3000 }); // 3 saniye
          t.show();
          return t;
        });
      });
    </script>
  </body>
</html>
